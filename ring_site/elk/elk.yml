---
- hosts : poc-elk1,poc-elk2,poc-elk3
  remote_user: root
  gather_facts: no
  tasks :

    - name: Add repository
      yum_repository:
        name: epel
        description: EPEL YUM repo
        file : epel
        baseurl: http://download.fedoraproject.org/pub/epel/$releasever/$basearch/
        proxy : http://9.115.78.100:8085
        enabled : yes
        gpgcheck: no


    - name: Add elasticsearch-2.x repository
      yum_repository:
        name: elasticsearch-2.x
        description: Elasticsearch repository for 2.x packages
        file :  elasticsearch
        baseurl: http://packages.elastic.co/elasticsearch/2.x/centos
        proxy : http://9.115.78.100:8085
        enabled : yes
        gpgcheck: no



    - name: install elasticsearch
      yum : name=elasticsearch state=latest

    - name: Add kibana-4.4
      yum_repository:
        name: kibana-4.4
        description: Kibana repository for 4.4.x packages
        file : kibana 
        baseurl: http://packages.elastic.co/kibana/4.4/centos
        proxy : http://9.115.78.100:8085
        enabled : yes
        gpgcheck: no
        gpgkey : http://packages.elastic.co/GPG-KEY-elasticsearch


    - name: install kibana
      yum : name=kibana state=latest


- hosts : poc-log
  remote_user: root
  gather_facts: no
  tasks :
    - name: Add logstash-2.2
      yum_repository:
        name: logstash-2.2
        description: logstash repository for 2.2 packages
        file : logstash
        baseurl: http://packages.elasticsearch.org/logstash/2.2/centos
        proxy : http://9.115.78.100:8085
        enabled : yes
        gpgcheck: no
        gpgkey : http://packages.elastic.co/GPG-KEY-elasticsearch


    - name: install logstash
      yum : name=logstash state=latest
    
    - name : copy logrotate_rsyslog.conf
      copy : src=logrotate_rsyslog.conf dest=/etc/logrotate.d/rsyslog  mode=0644

    - name : copy logcollector-mgmt_rsyslog.conf
      copy : src=logcollector-mgmt_rsyslog.conf dest=/etc/rsyslog.conf mode=0644

    - name : copy logcollector-mgmt_60-openstack.conf
      copy : src=logcollector-mgmt_60-openstack.conf dest=/etc/rsyslog.d/60-openstack.conf mode=0644
   

    - name : firewalld 514 tcp
      firewalld: port=514/tcp permanent=true state=enabled immediate=yes

    - name : firewalld 514 udp
      firewalld: port=514/udp permanent=true state=enabled immediate=yes

    - name : firewalld 8080 tcp
      firewalld: port=8080/tcp permanent=true state=enabled immediate=yes

    - name : rsyslog start
      service : name=rsyslog state=restarted enabled=yes

- hosts : r1-compute-server
  remote_user: root
  gather_facts: no
  tasks:
    - name : copy castelnaud_rsyslog.conf
      copy : src=castelnaud_rsyslog.conf dest=/etc/rsyslog.conf mode=0644

    - name : copy castelnaud_60-openstack-compute.conf
      copy : src=castelnaud_60-openstack-compute.conf dest=/etc/rsyslog.d/60-openstack-compute.conf mode=0644

    - name : rsyslog start
      service : name=rsyslog state=restarted enabled=yes



- hosts : r1-controller
  remote_user: root
  gather_facts: no
  tasks:
    - name : copy ctl_rsyslog.conf  
      copy : src=ctl_rsyslog.conf dest=/etc/rsyslog.conf mode=0644

    - name : copy ctl_60-openstack-agent.conf
      copy : src=ctl_60-openstack-agent.conf dest=/etc/rsyslog.d/60-openstack-agent.conf mode=0644

    - name : rsyslog start
      service : name=rsyslog state=restarted enabled=yes

