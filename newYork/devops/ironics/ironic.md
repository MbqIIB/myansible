
ironic conductor node: 192.168.191.197
ironic baremetal node: (use nova list to get the ip address)
The related files are at /root/ironic_p8le of ironic conductor node.
 
Here are the configuration steps:

import image
glance image-create --name p8el-deploy-vmlinuz --visibility public --disk-format aki --container-format bare < deploy-vmlinuz
glance image-create --name p8el-deploy-initrd --visibility public --container-format bare --disk-format ari < deploy-initrd
glance image-create --name Ubuntu16.04.1-ppc64le-baremetal  --disk-format qcow2 --container-format bare < /tmp/images/Ubuntu_16.04
 
[Ironic API]
yum install openstack-ironic-api
Configure the ironic.conf correctly, then start the ironic-api service. Be careful about the ironic port 6385, make sure the iptables rules can accept the tcp request from baremetal nodes.
systemctl start openstack-ironic-api
 
 
Register service and endpoint in keystone
 
SERVICE_ID=`keystone service-list | awk  '/ironic/ {print $2}'`
IRONIC_NODE=192.168.191.201
keystone endpoint-create \
--region=NY-DevOps1 \
--service-id=$SERVICE_ID \
--publicurl=http://$IRONIC_NODE:6385 \
--internalurl=http://$IRONIC_NODE:6385 \
--adminurl=http://$IRONIC_NODE:6385
 
[Network Node]  I runs these command below on net-n2
 
TENANT_ID=$(keystone tenant-list | grep admin |head -n1 | cut -d' ' -f2)
neutron net-create --tenant-id $TENANT_ID --shared --provider:network_type vxlan baremetal-private
net_id=$(neutron net-list | grep baremetal-private | cut -d' ' -f2)
neutron subnet-create --tenant-id $TENANT_ID --ip_version 4 --gateway 192.168.128.160 --name baremetal-private-subnet $net_id 192.168.128.0/18 --allocation-pool start=192.168.128.161,end=192.168.128.171 --enable-dhcp
 
ovs-vsctl add-br brbm
ip link add brbm-tap1 type veth peer name ovs-tap1
ovs-vsctl add-port brbm brbm-tap1
ip link set dev brbm up
ip link set dev brbm-tap1 up
ip link set dev ovs-tap1 up
ovs-vsctl add-port brbm eth0 && ip addr del  192.168.191.206/18 dev eth0 && ip addr add 192.168.191.206/18 dev brbm
ovs-vsctl add-port br-int ovs-tap1 tag=3  # tag number is as same as the tap port generated by the neutron command above.
 
 
[Nova-compute]
 
At first like the kvm compute nodes, make sure the services `openstack-nova-compute` ,`neutron-openvswitch-agent` works correctly.
 
Then configure the nova.conf to enable ironic driver
[default]
scheduler_host_manager = nova.scheduler.ironic_host_manager.IronicHostManager
compute_driver = nova.virt.ironic.IronicDriver
firewall_driver = nova.virt.firewall.NoopFirewallDriver
[ironic]
api_endpoint = http://ctl-n1:6385/v1
admin_tenant_name = services
admin_url = http://ctl-n1:35357/v2.0
admin_password = devopscloudpw
admin_username = ironic
 
[ironic-conductor]
yum install tftp-server xinetd  # tftp server
change iptables rules to make sure tftp service is reachable from outside network
 
copy the modified files and overwrite the original one.
ironic/drivers/modules/pxe.py
ironic/common/pxe_utils.py
 
 
configure /etc/xinetd.d/tftp
service tftp
{
           socket_type            = dgram
           protocol               = udp
           wait               = yes
           user               = root
           server             = /usr/sbin/in.tftpd
           server_args            = -v -v -v -v -v --map-file /map-file /tftpboot
           disable            = no
           per_source             = 11
           cps                = 100 2
           flags              = IPv4
}
 
cat /map-file
re ^(/tftpboot/) /tftpboot/\2
re ^/tftpboot/ /tftpboot/
re ^(^/) /tftpboot/\1
re ^([^/]) /tftpboot/\1
 
configure ironic.conf
[DEFAULT]
enabled_drivers=pxe_ipmitool
 
[pxe]
tftp_server=192.168.191.197

[conductor]
automated_clean=false
 
TEST
 
IRONIC_NODE_IPMI_ADDRESS="192.168.33.71"
IRONIC_NODE_IPMI_USERNAME=ADMIN
IRONIC_NODE_IPMI_PASSWORD=admin
NODE_MAC_ADDRESS="7c:fe:90:96:7c:f0"
MY_DEPLOY_VMLINUZ_UUID=`glance image-list | grep p8el-deploy-vmlinuz | awk '{print $2}'`
MY_DEPLOY_INITRD_UUID=`glance image-list | grep p8el-deploy-initrd | awk '{print $2}'`
IRONIC_NODE=`ironic node-create --driver pxe_ipmitool --name p8le -i ipmi_address=$IRONIC_NODE_IPMI_ADDRESS   -i ipmi_username=$IRONIC_NODE_IPMI_USERNAME \
        -i ipmi_password=$IRONIC_NODE_IPMI_PASSWORD -i deploy_kernel=$MY_DEPLOY_VMLINUZ_UUID -i deploy_ramdisk=$MY_DEPLOY_INITRD_UUID\
        -p memory_mb=32768 -p cpus=192 -p local_gb=300 -p cpu_arch=ppc64le \
         | grep uuid | grep -v chassis_uuid | \
         awk '{print $4}'`
 
ironic port-create -a $NODE_MAC_ADDRESS -n $IRONIC_NODE
# whole disk image, local boot
ironic node-update $IRONIC_NODE add properties/capabilities='boot_option:local'
 
ssh-keygen -f nova_key
nova keypair-add --pub-key nova_key.pub nova_key

net_id=$(neutron net-list | awk '/baremetal-private/ {print $2}')
MY_IMAGE_UUID=$(glance image-list | grep Ubuntu16.04.1-ppc64le-baremetal | head -n 1 | awk '{print $2}')
nova boot --flavor ppc64le-baremetal --image $MY_IMAGE_UUID power_baremetal_test  --nic net-id=$net_id  --security-groups default --key-name nova_key
 
reinstall the baremetal
nova delete power_baremetal_test
net_id=$(neutron net-list | awk '/baremetal-private/ {print $2}')
MY_IMAGE_UUID=xxxxxxxxxxxxx
nova boot --flavor ppc64le-baremetal --image $MY_IMAGE_UUID power_baremetal_test  --nic net-id=$net_id  --security-groups default --key-name nova_key




https://docs.openstack.org/project-install-guide/baremetal/ocata/deploy-ramdisk.html


guestfish --rw -a Ubuntu_16.04 -i edit /root/.ssh/authorized_keys
root@hnode6-10:~# glance image-create --name Ubuntu16.04.1-ppc64le-baremetal-ansiblekey  --disk-format qcow2 --container-format bare < Ubuntu_16.04
guestfish --rw -a ubuntu-14.04.5-server-cloudimg-ppc64el.qcow2 -i mkdir /root/.ssh
root@hnode6-10:~# guestfish --rw -a ubuntu-14.04.5-server-cloudimg-ppc64el.qcow2 -i touch /root/.ssh/authorized_keys
root@hnode6-10:~# guestfish --rw -a ubuntu-14.04.5-server-cloudimg-ppc64el.qcow2 -i edit /root/.ssh/authorized_keys
root@hnode6-10:~# guestfish --rw -a ubuntu-14.04.5-server-cloudimg-ppc64el.qcow2 -i file /root/.ssh/authorized_keys
OpenSSH RSA public key


source /root/openrc
glance image-create --name ubuntu-14.04.5-server-baremetal-ansiblekey  --disk-format qcow2 --container-format bare < ubuntu-14.04.5-server-cloudimg-ppc64el.qcow2

glance image-download ca33bd36-0d82-4745-8fb2-655f29f54bf2  --file ubuntu-14.04.5-server-baremetal-ansiblekey_v1.qcow2
glance image-delete ca33bd36-0d82-4745-8fb2-655f29f54bf2

glance image-create --name ubuntu-14.04.5-server-baremetal-ansiblekey_v1  --disk-format qcow2 --container-format bare --visibility=public < ubuntu-14.04.5-server-baremetal-ansiblekey_v1.qcow2





