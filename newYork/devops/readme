


HOST_PREFIX=poc-ctl
perl -pi -e "s/$HOST_PREFIX"3"/$HOST_PREFIX"0"/g" /etc/haproxy/*
perl -pi -e "s/$HOST_PREFIX"3"/$HOST_PREFIX"0"/g" /etc/my.cnf.d/server.cnf
perl -pi -e "s/$HOST_PREFIX"3"/$HOST_PREFIX"0"/g" /etc/corosync/corosync.conf



pcs cluster start --all
/usr/bin/galera_new_cluster
pcs cluster unstandby --all
pcs resource

resource update INTERNAL_VIP ip=192.168.191.190 cidr_netmask=18



HOSTVIP=192.168.191.190
OLDVIP=10.0.0.131
perl -pi -e "s/$OLDVIP/$HOSTVIP/g" /etc/sysconfig/iptables
perl -pi -e "s/$OLDVIP/$HOSTVIP/g" /etc/sysconfig/iptables.save

HOSTVIP=192.168.191.194
OLDVIP=10.0.0.134
perl -pi -e "s/$OLDVIP/$HOSTVIP/g" /etc/sysconfig/iptables
perl -pi -e "s/$OLDVIP/$HOSTVIP/g" /etc/sysconfig/iptables.save

iptables-restore < /etc/sysconfig/iptables.save


ansible controller-server -m shell -a "date -u"
ansible controller-server -m shell -a "rm -rf /var/log/rabbitmq/*localhost*"

ansible controller-server -m shell -a "rm -rf /var/log/rabbitmq/*"
ansible controller-server -m shell -a "rm -rf /var/lib/rabbitmq/mnesia/*localhost*"

ansible controller-server -m shell -a "rm -rf /var/lib/rabbitmq/mnesia/rabbit@poc-ctl0/msg_store_persistent/*"
ansible controller-server -m shell -a "rm -rf /var/lib/rabbitmq/mnesia/rabbit@poc-ctl1/msg_store_persistent/*"
ansible controller-server -m shell -a "rm -rf /var/lib/rabbitmq/mnesia/rabbit@poc-ctl2/msg_store_persistent/*"


ansible controller-server -m shell -a "rm -rf /var/lib/rabbitmq/mnesia/rabbit@poc-ctl0/msg_store_transient/*"
ansible controller-server -m shell -a "rm -rf /var/lib/rabbitmq/mnesia/rabbit@poc-ctl1/msg_store_transient/*"
ansible controller-server -m shell -a "rm -rf /var/lib/rabbitmq/mnesia/rabbit@poc-ctl2/msg_store_transient/*"


ansible controller-server -m shell -a "timedatectl"
ansible controller-server -m shell -a "timedatectl list-timezones"
ansible controller-server -m shell -a "timedatectl set-timezone America/New_York"

ansible controller-server -m shell -a "timedatectl set-timezone Asia/Shanghai"


VLAN_RANGE=physnet1:2000:2020
sed -i "s/^network_vlan_ranges.*$/network_vlan_ranges=$VLAN_RANGE/g" /etc/neutron/plugin.ini
sed -i "s/^network_vlan_ranges.*$/network_vlan_ranges=$VLAN_RANGE/g" /etc/neutron/plugins/ml2/ml2_conf.ini



ansible net-server -m shell -a "timedatectl set-timezone Asia/Shanghai"
ansible net-server -m shell -a "date -s '15:53:30' "


ovs-vsctl add-br br-data




rpm -ivh https://repos.fedorapeople.org/repos/openstack/openstack-mitaka/rdo-release-mitaka-6.noarch.rpm
ssh svp2
route -n
ovs-vsctl add-port br-data enp1s0


yum install  http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-8.noarch.rpm
virt-edit -d CentOS7.2-x86_64_poc-HA-ctl0  /etc/sysconfig/network-scripts/ifcfg-eth0
virt-edit -d CentOS7.2-x86_64_poc-HA-net0  /etc/sysconfig/network-scripts/ifcfg-eth0
 165  2016-11-30 23:37:46 :: scp -r /root/.ssh/  net-vip:/root/
 1066  2016-11-30 23:37:56 :: scp -r /root/.ssh/  ctl-vip:/root/
 1067  2016-11-30 23:38:32 :: scp -r eth2  ctl-vip://etc/sysconfig/network-scripts/ifcfg-eth2
 1068  2016-11-30 23:38:49 :: scp -r net2  net-vip://etc/sysconfig/network-scripts/ifcfg-eth2

 scp -r /etc/resolv.conf   net-vip:/etc/
 scp -r /etc/resolv.conf   ctl-vip:/etc/

 scp -r /etc/selinux/config   net-vip:/etc/selinux/config
 scp -r /etc/selinux/config   ctl-vip:/etc/selinux/config


hostnamectl set-hostname net-vip
hostnamectl set-hostname ctl-vip

 yum install -y yum-utils
packstack --answer-file=install/answer.conf 

mysql -u root -p



yum install -y pcs fence-agents-all


yum install -y haproxy


Chao Zhu(祝超): 
11:32:52 AM: yum install -y pcs fence-agents-all
passwd hacluster
systemctl start pcsd.service
systemctl enable pcsd.service
 

11:33:07 AM: yum install -y haproxy
copy haproxy.cfg to /etc/haproxy/haproxy.cfg




/etc/neutron/plugins/ml2/openvswitch_agent.ini:206:local_ip = 10.31.252.66
/etc/sysconfig/network-scripts/ifcfg-eth1
sed -i "s/^local_ip.*/local_ip=10.10.72.25/g" /etc/neutron/plugins/ml2/openvswitch_agent.ini


passwd hacluster / devops1cloud









pcs cluster auth 192.168.191.201 192.168.191.202 192.168.191.203 -uhacluster -pdevops1cloud
pcs cluster setup --start --name openstack_cluster 192.168.191.201 192.168.191.202 192.168.191.203
pcs property set stonith-enabled=false
pcs property set start-failure-is-fatal=false

